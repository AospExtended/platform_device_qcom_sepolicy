From 0f065b53ffc650417a6d31ee46a6d7a38ef849a6 Mon Sep 17 00:00:00 2001
From: acras01 <acras1@gmail.com>
Date: Fri, 18 Dec 2020 09:21:00 +0200
Subject: [PATCH] sepolicy: Adding rules for servicetracker HAL for legacy
 target.

Also adding file_context for servicetracker V1.2

Change-Id: I6d30694b0b7496e4b0c910106ee76713efa4724c
---
 legacy/vendor/common/attributes               |  4 ++
 legacy/vendor/common/file_contexts            |  1 +
 .../vendor/common/hal_srvctracker_default.te  | 42 +++++++++++++++++++
 legacy/vendor/common/hwservice.te             |  1 +
 legacy/vendor/common/hwservice_contexts       |  1 +
 legacy/vendor/common/system_server.te         |  2 +
 6 files changed, 51 insertions(+)
 create mode 100644 legacy/vendor/common/hal_srvctracker_default.te

diff --git a/legacy/vendor/common/attributes b/legacy/vendor/common/attributes
index 641db018..a0263995 100644
--- a/legacy/vendor/common/attributes
+++ b/legacy/vendor/common/attributes
@@ -116,6 +116,10 @@ attribute hal_wifilearner;
 attribute hal_wifilearner_client;
 attribute hal_wifilearner_server;
 
+attribute hal_srvctracker;
+attribute hal_srvctracker_client;
+attribute hal_srvctracker_server;
+
 attribute hal_fm;
 attribute hal_fm_client;
 attribute hal_fm_server;
diff --git a/legacy/vendor/common/file_contexts b/legacy/vendor/common/file_contexts
index 21de4e27..81a86394 100644
--- a/legacy/vendor/common/file_contexts
+++ b/legacy/vendor/common/file_contexts
@@ -332,6 +332,7 @@
 /(vendor|system/vendor)/bin/chre                u:object_r:chre_exec:s0
 /(vendor|system/vendor)/bin/tloc_daemon         u:object_r:tlocd_exec:s0
 /(vendor|system/vendor)/bin/hw/vendor\.qti\.hardware\.factory@1\.0-service      u:object_r:vendor_hal_factory_qti_default_exec:s0
+/(vendor|system/vendor)/bin/hw/vendor\.qti\.hardware\.servicetracker@1\.[0-2]-service u:object_r:vendor_hal_srvctracker_default_exec:s0
 /(vendor|system/vendor)/bin/hw/vendor\.qti\.hardware\.display\.allocator@1\.0-service   u:object_r:hal_graphics_allocator_default_exec:s0
 /(vendor|system/vendor)/bin/hw/vendor\.qti\.hardware\.display\.allocator-service   u:object_r:hal_graphics_allocator_default_exec:s0
 /(vendor|system/vendor)/bin/hw/vendor\.qti\.hardware\.display\.composer@1\.0-service   u:object_r:hal_graphics_composer_default_exec:s0
diff --git a/legacy/vendor/common/hal_srvctracker_default.te b/legacy/vendor/common/hal_srvctracker_default.te
new file mode 100644
index 00000000..28b83e05
--- /dev/null
+++ b/legacy/vendor/common/hal_srvctracker_default.te
@@ -0,0 +1,42 @@
+# Copyright (c) 2020, The Linux Foundation. All rights reserved.
+#
+# Redistribution and use in source and binary forms, with or without
+# modification, are permitted provided that the following conditions are
+# met:
+#     * Redistributions of source code must retain the above copyright
+#       notice, this list of conditions and the following disclaimer.
+#     * Redistributions in binary form must reproduce the above
+#       copyright notice, this list of conditions and the following
+#       disclaimer in the documentation and/or other materials provided
+#       with the distribution.
+#     * Neither the name of The Linux Foundation nor the names of its
+#       contributors may be used to endorse or promote products derived
+#       from this software without specific prior written permission.
+#
+# THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESS OR IMPLIED
+# WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
+# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT
+# ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS
+# BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
+# CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
+# SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
+# BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
+# WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
+# OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN
+# IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+
+#Define Domain
+type vendor_hal_srvctracker_default, domain;
+type vendor_hal_srvctracker_default_exec, exec_type, vendor_file_type, file_type;
+hal_server_domain(vendor_hal_srvctracker_default, hal_srvctracker)
+init_daemon_domain(vendor_hal_srvctracker_default)
+
+binder_call(hal_srvctracker_client, hal_srvctracker_server)
+binder_call(hal_srvctracker_server, hal_srvctracker_client)
+
+add_hwservice(hal_srvctracker, vendor_hal_srvctracker_hwservice)
+
+allow hal_srvctracker_client vendor_hal_srvctracker_hwservice:hwservice_manager find;
+hwbinder_use(hal_srvctracker)
+
+get_prop(vendor_hal_srvctracker_default, hwservicemanager_prop)
\ No newline at end of file
diff --git a/legacy/vendor/common/hwservice.te b/legacy/vendor/common/hwservice.te
index a29cbcf7..00e508fd 100644
--- a/legacy/vendor/common/hwservice.te
+++ b/legacy/vendor/common/hwservice.te
@@ -58,6 +58,7 @@ type hal_sensorscalibrate_qti_hwservice, hwservice_manager_type;
 type hal_scve_hwservice, hwservice_manager_type;
 type hal_pasrmanager_hwservice, hwservice_manager_type;
 type hal_wifilearner_hwservice, hwservice_manager_type;
+type vendor_hal_srvctracker_hwservice, hwservice_manager_type, protected_hwservice;
 type hal_fm_hwservice, hwservice_manager_type;
 type hal_btconfigstore_hwservice, hwservice_manager_type;
 type hal_capabilityconfigstore_qti_hwservice, hwservice_manager_type;
diff --git a/legacy/vendor/common/hwservice_contexts b/legacy/vendor/common/hwservice_contexts
index 5a579ad6..17b5c2c9 100644
--- a/legacy/vendor/common/hwservice_contexts
+++ b/legacy/vendor/common/hwservice_contexts
@@ -85,6 +85,7 @@ vendor.qti.hardware.factory::IFactory                        u:object_r:vendor_h
 vendor.qti.hardware.display.allocator::IQtiAllocator         u:object_r:hal_graphics_allocator_hwservice:s0
 vendor.qti.hardware.display.composer::IQtiComposer           u:object_r:hal_graphics_composer_hwservice:s0
 vendor.qti.hardware.soter::ISoter                            u:object_r:hal_soter_hwservice:s0
+vendor.qti.hardware.servicetracker::IServicetracker          u:object_r:vendor_hal_srvctracker_hwservice:s0
 vendor.qti.hardware.tui_comm::ITuiComm                       u:object_r:hal_tui_comm_hwservice:s0
 vendor.qti.hardware.qdutils_disp::IQdutilsDisp               u:object_r:hal_qdutils_disp_hwservice:s0
 vendor.qti.hardware.sensorscalibrate::ISensorsCalibrate      u:object_r:hal_sensorscalibrate_qti_hwservice:s0
diff --git a/legacy/vendor/common/system_server.te b/legacy/vendor/common/system_server.te
index ca346388..79fa0ca8 100644
--- a/legacy/vendor/common/system_server.te
+++ b/legacy/vendor/common/system_server.te
@@ -55,6 +55,8 @@ allow system_server bluetooth:unix_stream_socket connectto;
 unix_socket_send(system_server, iop, dumpstate)
 unix_socket_connect(system_server, iop, dumpstate)
 
+hal_client_domain(system_server, hal_srvctracker)
+
 # allow  system/framework applications to update the dpmd configuration files
 #unix_socket_connect(system_server, dpmd, dpmd);
 #allow system_server { dpmd_socket socket_device }:sock_file w_file_perms;
