From e96d4d30ed0950d6c7797e9586ddb1d4e0152ed0 Mon Sep 17 00:00:00 2001
From: acras01 <acras1@gmail.com>
Date: Fri, 18 Dec 2020 09:38:21 +0200
Subject: [PATCH] sepolicy: add policies for DSP HAL manager

Change-Id: I1e56eee11316eb4b7ecf83d18c50bde05d262dc7
---
 legacy/vendor/common/attributes         |  4 ++
 legacy/vendor/common/dspservice.te      | 60 +++++++++++++++++++++++++
 legacy/vendor/common/file_contexts      |  2 +
 legacy/vendor/common/hwservice.te       |  2 +-
 legacy/vendor/common/hwservice_contexts |  1 +
 legacy/vendor/common/shell.te           |  3 ++
 legacy/vendor/test/untrusted_app_25.te  |  5 ++-
 legacy/vendor/test/untrusted_app_27.te  |  5 ++-
 legacy/vendor/test/untrusted_app_29.te  | 29 ++++++++++++
 9 files changed, 108 insertions(+), 3 deletions(-)
 create mode 100644 legacy/vendor/common/dspservice.te
 create mode 100644 legacy/vendor/test/untrusted_app_29.te

diff --git a/legacy/vendor/common/attributes b/legacy/vendor/common/attributes
index a0263995..cfced5d6 100644
--- a/legacy/vendor/common/attributes
+++ b/legacy/vendor/common/attributes
@@ -135,3 +135,7 @@ attribute hal_dataconnection_qti_server;
 attribute hal_capabilityconfigstore_qti;
 attribute hal_capabilityconfigstore_qti_client;
 attribute hal_capabilityconfigstore_qti_server;
+
+attribute vendor_hal_dspmanager;
+attribute vendor_hal_dspmanager_client;
+attribute vendor_hal_dspmanager_server;
\ No newline at end of file
diff --git a/legacy/vendor/common/dspservice.te b/legacy/vendor/common/dspservice.te
new file mode 100644
index 00000000..96dee40f
--- /dev/null
+++ b/legacy/vendor/common/dspservice.te
@@ -0,0 +1,60 @@
+# Copyright (c) 2020, The Linux Foundation. All rights reserved.
+
+# Redistribution and use in source and binary forms, with or without
+# modification, are permitted provided that the following conditions are
+# met:
+#    * Redistributions of source code must retain the above copyright
+#      notice, this list of conditions and the following disclaimer.
+#    * Redistributions in binary form must reproduce the above
+#      copyright notice, this list of conditions and the following
+#      disclaimer in the documentation and/or other materials provided
+#      with the distribution.
+#    * Neither the name of The Linux Foundation nor the names of its
+#      contributors may be used to endorse or promote products derived
+#      from this software without specific prior written permission.
+#
+# THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESS OR IMPLIED
+# WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
+# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT
+# ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS
+# BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
+# CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
+# SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
+# BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
+# WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
+# OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN
+# IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+
+# Policy for DSP HAL service
+type vendor_dspservice, domain;
+type vendor_dspservice_exec, exec_type, vendor_file_type, file_type;
+
+# Started by init
+init_daemon_domain(vendor_dspservice)
+
+# Allow permissions required for this HAL server to offer a
+# HAL implementation of the specified type over HwBinder
+hal_server_domain(vendor_dspservice, vendor_hal_dspmanager)
+
+# Allow DSP clients to perform binder IPC to DSP HAL server
+binder_call(vendor_hal_dspmanager_client, vendor_hal_dspmanager_server)
+binder_call(vendor_hal_dspmanager_server, vendor_hal_dspmanager_client)
+
+# Add dspservice to hwservice_manager and allow it to be discovered
+hal_attribute_hwservice(vendor_hal_dspmanager, vendor_hal_dspmanager_hwservice)
+
+# For reading dir/files on "/vendor/dsp"
+r_dir_file(vendor_dspservice, adsprpcd_file)
+
+# For reading "vendor.fastrpc." properties
+get_prop(vendor_dspservice, adsprpc_prop)
+
+# Allow access to adsprpc secure and non-secure devices
+allow vendor_dspservice qdsp_device:chr_file r_file_perms;
+allow vendor_dspservice xdsp_device:chr_file r_file_perms;
+
+# Allow access to adsprpc ION device
+allow vendor_dspservice ion_device:chr_file r_file_perms;
+
+# Access to wakelock sysfs
+wakelock_use(vendor_dspservice)
\ No newline at end of file
diff --git a/legacy/vendor/common/file_contexts b/legacy/vendor/common/file_contexts
index 81a86394..bad2ecd3 100644
--- a/legacy/vendor/common/file_contexts
+++ b/legacy/vendor/common/file_contexts
@@ -246,6 +246,7 @@
 /(vendor|system/vendor)/bin/hostapd_cli         u:object_r:hostapd_exec:s0
 /(vendor|system/vendor)/bin/adsprpcd            u:object_r:adsprpcd_exec:s0
 /(vendor|system/vendor)/bin/cdsprpcd            u:object_r:cdsprpcd_exec:s0
+/(vendor|system/vendor)/bin/dspservice          u:object_r:vendor_dspservice_exec:s0
 /(vendor|system/vendor)/bin/wpa_cli             u:object_r:wcnss_service_exec:s0
 /(vendor|system/vendor)/bin/mdm_helper          u:object_r:mdm_helper_exec:s0
 /(vendor|system/vendor)/bin/mdm_helper_proxy    u:object_r:mdm_helper_exec:s0
@@ -689,6 +690,7 @@
 /(vendor|system/vendor)/lib(64)?/libadsprpc\.so             u:object_r:same_process_hal_file:s0
 /(vendor|system/vendor)/lib(64)?/libcdsprpc\.so             u:object_r:same_process_hal_file:s0
 /(vendor|system/vendor)/lib(64)?/libsdsprpc\.so             u:object_r:same_process_hal_file:s0
+/(vendor|system/vendor)/lib(64)?/vendor.qti.hardware.dsp@1.0\.so     u:object_r:same_process_hal_file:s0
 /(vendor|system/vendor)/lib(64)?/libdiag\.so                u:object_r:same_process_hal_file:s0
 /(vendor|system/vendor)/lib(64)?/libtime_genoff\.so         u:object_r:same_process_hal_file:s0
 
diff --git a/legacy/vendor/common/hwservice.te b/legacy/vendor/common/hwservice.te
index 00e508fd..df66a38e 100644
--- a/legacy/vendor/common/hwservice.te
+++ b/legacy/vendor/common/hwservice.te
@@ -64,4 +64,4 @@ type hal_btconfigstore_hwservice, hwservice_manager_type;
 type hal_capabilityconfigstore_qti_hwservice, hwservice_manager_type;
 type hal_qseecom_hwservice, hwservice_manager_type, protected_hwservice;
 type hal_perfcallback_hwservice, hwservice_manager_type, protected_hwservice;
-
+type vendor_hal_dspmanager_hwservice, hwservice_manager_type;
diff --git a/legacy/vendor/common/hwservice_contexts b/legacy/vendor/common/hwservice_contexts
index 17b5c2c9..6c0593b8 100644
--- a/legacy/vendor/common/hwservice_contexts
+++ b/legacy/vendor/common/hwservice_contexts
@@ -104,3 +104,4 @@ vendor.qti.hardware.bluetooth_sar::IBluetoothSar             u:object_r:hal_blue
 com.dsi.ant::IAnt                                            u:object_r:hal_bluetooth_hwservice:s0
 vendor.qti.hardware.qseecom::IQSEECom                        u:object_r:hal_qseecom_hwservice:s0
 vendor.qti.hardware.perf::IPerfCallback                      u:object_r:hal_perfcallback_hwservice:s0
+vendor.qti.hardware.dsp::IDspService                         u:object_r:vendor_hal_dspmanager_hwservice:s0
\ No newline at end of file
diff --git a/legacy/vendor/common/shell.te b/legacy/vendor/common/shell.te
index e083d54a..0c6f6c70 100644
--- a/legacy/vendor/common/shell.te
+++ b/legacy/vendor/common/shell.te
@@ -32,3 +32,6 @@ r_dir_file(shell, RIDL_data_file)
 # allow read access for shell
 r_dir_file(shell, qti_logkit_priv_data_file)
 r_dir_file(shell, qti_logkit_pub_data_file)
+
+# allow any 3rd party shell app to be a client of DSP HAL
+hal_client_domain(shell, vendor_hal_dspmanager)
\ No newline at end of file
diff --git a/legacy/vendor/test/untrusted_app_25.te b/legacy/vendor/test/untrusted_app_25.te
index 46e7a1d7..cab424d0 100644
--- a/legacy/vendor/test/untrusted_app_25.te
+++ b/legacy/vendor/test/untrusted_app_25.te
@@ -1,4 +1,4 @@
-# Copyright (c) 2018, The Linux Foundation. All rights reserved.
+# Copyright (c) 2018, 2020, The Linux Foundation. All rights reserved.
 #
 # Redistribution and use in source and binary forms, with or without
 # modification, are permitted provided that the following conditions are
@@ -33,3 +33,6 @@ r_dir_file(untrusted_app_25, vendor_gles_data_file);
 allow untrusted_app_25 vendor_gles_data_file:dir rw_dir_perms;
 allow untrusted_app_25 vendor_gles_data_file:file rw_file_perms;
 ')
+
+# allow app to be a client of DSP HAL
+hal_client_domain(untrusted_app_25, vendor_hal_dspmanager)
\ No newline at end of file
diff --git a/legacy/vendor/test/untrusted_app_27.te b/legacy/vendor/test/untrusted_app_27.te
index 4a076497..e40e9433 100644
--- a/legacy/vendor/test/untrusted_app_27.te
+++ b/legacy/vendor/test/untrusted_app_27.te
@@ -1,4 +1,4 @@
-# Copyright (c) 2018, The Linux Foundation. All rights reserved.
+# Copyright (c) 2018, 2020, The Linux Foundation. All rights reserved.
 #
 # Redistribution and use in source and binary forms, with or without
 # modification, are permitted provided that the following conditions are
@@ -33,3 +33,6 @@ r_dir_file(untrusted_app_27, vendor_gles_data_file);
 allow untrusted_app_27 vendor_gles_data_file:dir rw_dir_perms;
 allow untrusted_app_27 vendor_gles_data_file:file rw_file_perms;
 ')
+
+# allow app to be a client of DSP HAL
+hal_client_domain(untrusted_app_27, vendor_hal_dspmanager)
\ No newline at end of file
diff --git a/legacy/vendor/test/untrusted_app_29.te b/legacy/vendor/test/untrusted_app_29.te
new file mode 100644
index 00000000..7a7a5b16
--- /dev/null
+++ b/legacy/vendor/test/untrusted_app_29.te
@@ -0,0 +1,29 @@
+# Copyright (c) 2020, The Linux Foundation. All rights reserved.
+#
+# Redistribution and use in source and binary forms, with or without
+# modification, are permitted provided that the following conditions are
+# met:
+#     * Redistributions of source code must retain the above copyright
+#       notice, this list of conditions and the following disclaimer.
+#     * Redistributions in binary form must reproduce the above
+#       copyright notice, this list of conditions and the following
+#       disclaimer in the documentation and/or other materials provided
+#       with the distribution.
+#     * Neither the name of The Linux Foundation nor the names of its
+#       contributors may be used to endorse or promote products derived
+#       from this software without specific prior written permission.
+#
+# THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESS OR IMPLIED
+# WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
+# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT
+# ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS
+# BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
+# CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
+# SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
+# BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
+# WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
+# OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN
+# IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+
+# allow app to be a client of DSP HAL
+hal_client_domain(untrusted_app_29, vendor_hal_dspmanager)
\ No newline at end of file
